define("quizaccess_ratelimit/ratelimit",["exports","jquery","core/ajax","core/modal_factory","core_form/changechecker"],(function(_exports,_jquery,_ajax,_modal_factory,_changechecker){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_modal_factory=_interopRequireDefault(_modal_factory);const form="#mod_quiz_preflight_form",button=form+" input#id_submitbutton";let initialized=!1;_exports.init=maxDelay=>{if(initialized)return;const maxDelayUntil=Date.now()+1e3*maxDelay,handleClick=e=>{if("id_submitbutton"!==e.target.id)return;e.preventDefault(),e.stopPropagation();document.querySelector(button).disabled=!0,_ajax.default.call([{methodname:"quizaccess_ratelimit_get_waiting_time",args:{},done:response=>{if(maxDelay=Math.floor((maxDelayUntil-Date.now())/1e3),maxDelay=Math.max(0,maxDelay),response.seconds>=maxDelay){const rand=Math.floor(Math.random()*maxDelay);delaySubmit(rand,response.message)}else delaySubmit(response.seconds,response.message)},fail:()=>{const rand=Math.floor(10*Math.random());delaySubmit(rand)}}])},formElement=document.querySelector(form);formElement&&null===document.querySelector(".quizstartbuttondiv.quizsecuremoderequired")&&(formElement.addEventListener("click",handleClick,!0),formElement._ratelimitHandleClick=handleClick),initialized=!0};const delaySubmit=function(seconds){let message=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const buttonEl=document.querySelector(button);if(0===seconds)return void submitForm();seconds>10&&_modal_factory.default.create({body:message}).then((modal=>modal.show())).catch((()=>null));const endTime=Date.now()+1e3*seconds,buttonVal=buttonEl.value,checkSubmitCancelled=()=>!(0,_jquery.default)(form).is(":visible")&&(clearInterval(interval),clearTimeout(timeout),buttonEl.disabled=!1,buttonEl.value=buttonVal,!0),updateButtonValue=()=>{const secsLeft=Math.round((endTime-Date.now())/1e3),formatted=Math.floor(secsLeft/60).toString()+":"+(secsLeft%60).toString().padStart(2,"0");buttonEl.value=buttonVal+" ("+formatted+")",checkSubmitCancelled()};updateButtonValue();const interval=setInterval(updateButtonValue,1e3),timeout=setTimeout((()=>{clearInterval(interval),checkSubmitCancelled()||submitForm()}),1e3*seconds)},submitForm=function(){const formElement=document.querySelector(form);formElement._ratelimitHandleClick&&formElement.removeEventListener("click",formElement._ratelimitHandleClick,!0),(0,_changechecker.markFormSubmitted)(formElement);const buttonEl=document.querySelector(button);buttonEl.disabled=!1,buttonEl.click()}}));

//# sourceMappingURL=ratelimit.min.js.map