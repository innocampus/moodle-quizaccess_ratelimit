define("quizaccess_ratelimit/ratelimit",["exports","jquery","core/ajax","core/modal_factory","core_form/changechecker","core/notification"],(function(_exports,_jquery,_ajax,_modal_factory,_changechecker,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_modal_factory=_interopRequireDefault(_modal_factory),_notification=_interopRequireDefault(_notification);const form="#mod_quiz_preflight_form",button=form+" input#id_submitbutton";_exports.init=(maxDelay,popupRequired)=>{const maxDelayUntil=Date.now()+1e3*maxDelay,formElement=document.querySelector("#mod_quiz_preflight_form");formElement&&formElement.addEventListener("click",(e=>{"id_submitbutton"===e.target.id&&(e.preventDefault(),e.stopPropagation(),_ajax.default.call([{methodname:"quizaccess_ratelimit_get_waiting_time",args:{},done:response=>{if(maxDelay=Math.floor((maxDelayUntil-Date.now())/1e3),maxDelay=Math.max(0,maxDelay),response.seconds>=maxDelay){const rand=Math.floor(Math.random()*maxDelay);delaySubmit(rand,popupRequired,response.message)}else delaySubmit(response.seconds,popupRequired,response.message)},fail:()=>{const rand=Math.floor(10*Math.random());delaySubmit(rand,popupRequired)}}]))}),!0)};const delaySubmit=function(seconds,popupRequired){let message=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return function(message){if(0===seconds){if(!popupRequired)return void submitForm();{const formElement=document.querySelector("#mod_quiz_preflight_form");if(formElement){var formData=new FormData(formElement),serializedForm=new URLSearchParams(formData).toString().replace(/\bcancel=/,"x="),popupWindow=window.open(formElement.action+"?"+serializedForm,"quizpopup","width="+screen.width+", height="+screen.height);if(!popupWindow||0===popupWindow.outerHeight){message="Bitte erlauben Sie Pop-ups fÃ¼r diese Seite.";_notification.default.alert("Pop-up wurde blockiert",message)}return}}}seconds>10&&_modal_factory.default.create({body:message}).then((modal=>modal.show())).catch((()=>null));const endTime=Date.now()+1e3*seconds,buttonVal=(0,_jquery.default)(button).val(),checkSubmitCancelled=()=>!(0,_jquery.default)(form).is(":visible")&&(clearInterval(interval),clearTimeout(timeout),(0,_jquery.default)(button).prop("disabled",!1),(0,_jquery.default)(button).val(buttonVal),!0),updateButtonValue=()=>{const secsLeft=Math.round((endTime-Date.now())/1e3),formatted=Math.floor(secsLeft/60).toString()+":"+(secsLeft%60).toString().padStart(2,"0");(0,_jquery.default)(button).val(buttonVal+" ("+formatted+")"),checkSubmitCancelled()};updateButtonValue();const interval=setInterval(updateButtonValue,1e3),timeout=setTimeout((()=>{clearInterval(interval),checkSubmitCancelled()||submitForm()}),1e3*seconds)}(message)},submitForm=function(){const formEl=document.querySelector(form);(0,_changechecker.markFormSubmitted)(formEl),formEl.submit()}}));

//# sourceMappingURL=ratelimit.min.js.map