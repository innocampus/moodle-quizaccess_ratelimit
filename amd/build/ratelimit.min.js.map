{"version":3,"file":"ratelimit.min.js","sources":["../src/ratelimit.js"],"sourcesContent":["/**\n * Quiz rate limiting JS code.\n *\n * @module    mod_quiz/add_question_modal_launcher\n * @copyright 2021 Martin Gauk, TU Berlin <gauk@math.tu-berlin.de>\n */\n\nimport $ from 'jquery';\nimport Ajax from 'core/ajax';\nimport ModalFactory from 'core/modal_factory';\nimport {markFormSubmitted} from 'core_form/changechecker';\n\nconst form = '#mod_quiz_preflight_form';\nconst button = form + ' input#id_submitbutton';\nlet initialized = false;\n\nexport const init = (maxDelay) => {\n    if (initialized) {\n        return;\n    }\n\n    const maxDelayUntil = Date.now() + maxDelay * 1000;\n    // Eventhandling\n    const handleClick = (e) => {\n        if (e.target.id !== 'id_submitbutton') {\n            return;\n        }\n        e.preventDefault();\n        e.stopPropagation();\n        const buttonEl = document.querySelector(button);\n        buttonEl.disabled = true;\n\n        Ajax.call([{\n            methodname: 'quizaccess_ratelimit_get_waiting_time',\n            args: {},\n            done: (response) => {\n                maxDelay = Math.floor((maxDelayUntil - Date.now()) / 1000);\n                maxDelay = Math.max(0, maxDelay);\n                if (response.seconds >= maxDelay) {\n                    // Spread the delay between 0 and maxdelay evenly.\n                    const rand = Math.floor(Math.random() * maxDelay);\n                    delaySubmit(rand, response.message);\n                } else {\n                    delaySubmit(response.seconds, response.message);\n                }\n            },\n            fail: () => {\n                // Do a random short delay.\n                const rand = Math.floor(Math.random() * 10);\n                delaySubmit(rand);\n            }\n        }]);\n    };\n\n    // Register click listener to root element '#mod_quiz_preflight_form' in capture phase to prevent propagation\n    // to the button-click listener in mod/quiz/amd/src/preflight.js:66 and therefore stop this event from firing.\n    const formElement = document.querySelector(form);\n\n    // The secure mode popup will show the form again. So only add event at one location.\n    if (formElement && document.querySelector('.quizstartbuttondiv.quizsecuremoderequired') === null) {\n        formElement.addEventListener('click', handleClick, true);\n\n        // Save eventlistener reference for later removal in submitForm()\n        formElement._ratelimitHandleClick = handleClick;\n    }\n    initialized = true;\n};\n\nconst delaySubmit = function(seconds, message = '') {\n    const buttonEl = document.querySelector(button);\n    if (seconds === 0) {\n        submitForm();\n        return;\n    }\n\n    // Tell the user what is happening when the delay is too long.\n    if (seconds > 10) {\n        ModalFactory.create({\n            body: message,\n        }).then(\n            (modal) => modal.show()\n        ).catch(\n            () => null\n        );\n    }\n\n    const endTime = Date.now() + seconds * 1000;\n    const buttonVal = buttonEl.value;\n\n    const checkSubmitCancelled = () => {\n        // Submit is cancelled when the form is not visible, i.e. the modal was closed.\n        if ($(form).is(\":visible\")) {\n            return false;\n        }\n        clearInterval(interval);\n        clearTimeout(timeout);\n        buttonEl.disabled = false;\n        buttonEl.value = buttonVal;\n        return true;\n    };\n\n    const updateButtonValue = () => {\n        const secsLeft = Math.round((endTime - Date.now()) / 1000);\n        const formatted = Math.floor(secsLeft / 60).toString() + ':' +\n            (secsLeft % 60).toString().padStart(2, '0');\n        buttonEl.value = buttonVal + ' (' + formatted + ')';\n        checkSubmitCancelled();\n    };\n\n    updateButtonValue();\n    const interval = setInterval(updateButtonValue, 1000);\n\n    const timeout = setTimeout(() => {\n        clearInterval(interval);\n        if (!checkSubmitCancelled()) {\n            submitForm();\n        }\n    }, seconds * 1000);\n};\n\nconst submitForm = function() {\n    const formElement = document.querySelector(form);\n    // Remove eventlistener from the init function\n    if (formElement._ratelimitHandleClick) {\n        formElement.removeEventListener('click', formElement._ratelimitHandleClick, true);\n    }\n    markFormSubmitted(formElement);\n    const buttonEl = document.querySelector(button);\n    buttonEl.disabled = false;\n    buttonEl.click();\n};"],"names":["form","button","initialized","maxDelay","maxDelayUntil","Date","now","handleClick","e","target","id","preventDefault","stopPropagation","document","querySelector","disabled","call","methodname","args","done","response","Math","floor","max","seconds","rand","random","delaySubmit","message","fail","formElement","addEventListener","_ratelimitHandleClick","buttonEl","submitForm","create","body","then","modal","show","catch","endTime","buttonVal","value","checkSubmitCancelled","is","clearInterval","interval","clearTimeout","timeout","updateButtonValue","secsLeft","round","formatted","toString","padStart","setInterval","setTimeout","removeEventListener","click"],"mappings":"+dAYMA,KAAO,2BACPC,OAASD,KAAO,6BAClBE,aAAc,gBAEGC,cACbD,yBAIEE,cAAgBC,KAAKC,MAAmB,IAAXH,SAE7BI,YAAeC,OACG,oBAAhBA,EAAEC,OAAOC,UAGbF,EAAEG,iBACFH,EAAEI,kBACeC,SAASC,cAAcb,QAC/Bc,UAAW,gBAEfC,KAAK,CAAC,CACPC,WAAY,wCACZC,KAAM,GACNC,KAAOC,cACHjB,SAAWkB,KAAKC,OAAOlB,cAAgBC,KAAKC,OAAS,KACrDH,SAAWkB,KAAKE,IAAI,EAAGpB,UACnBiB,SAASI,SAAWrB,SAAU,OAExBsB,KAAOJ,KAAKC,MAAMD,KAAKK,SAAWvB,UACxCwB,YAAYF,KAAML,SAASQ,cAE3BD,YAAYP,SAASI,QAASJ,SAASQ,UAG/CC,KAAM,WAEIJ,KAAOJ,KAAKC,MAAsB,GAAhBD,KAAKK,UAC7BC,YAAYF,WAOlBK,YAAcjB,SAASC,cAAcd,MAGvC8B,aAAwF,OAAzEjB,SAASC,cAAc,gDACtCgB,YAAYC,iBAAiB,QAASxB,aAAa,GAGnDuB,YAAYE,sBAAwBzB,aAExCL,aAAc,SAGZyB,YAAc,SAASH,aAASI,+DAAU,SACtCK,SAAWpB,SAASC,cAAcb,WACxB,IAAZuB,oBACAU,aAKAV,QAAU,2BACGW,OAAO,CAChBC,KAAMR,UACPS,MACEC,OAAUA,MAAMC,SACnBC,OACE,IAAM,aAIRC,QAAUpC,KAAKC,MAAkB,IAAVkB,QACvBkB,UAAYT,SAASU,MAErBC,qBAAuB,MAErB,mBAAE5C,MAAM6C,GAAG,cAGfC,cAAcC,UACdC,aAAaC,SACbhB,SAASlB,UAAW,EACpBkB,SAASU,MAAQD,WACV,GAGLQ,kBAAoB,WAChBC,SAAW9B,KAAK+B,OAAOX,QAAUpC,KAAKC,OAAS,KAC/C+C,UAAYhC,KAAKC,MAAM6B,SAAW,IAAIG,WAAa,KACpDH,SAAW,IAAIG,WAAWC,SAAS,EAAG,KAC3CtB,SAASU,MAAQD,UAAY,KAAOW,UAAY,IAChDT,wBAGJM,0BACMH,SAAWS,YAAYN,kBAAmB,KAE1CD,QAAUQ,YAAW,KACvBX,cAAcC,UACTH,wBACDV,eAEK,IAAVV,UAGDU,WAAa,iBACTJ,YAAcjB,SAASC,cAAcd,MAEvC8B,YAAYE,uBACZF,YAAY4B,oBAAoB,QAAS5B,YAAYE,uBAAuB,wCAE9DF,mBACZG,SAAWpB,SAASC,cAAcb,QACxCgC,SAASlB,UAAW,EACpBkB,SAAS0B"}